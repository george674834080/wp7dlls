<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (c) Microsoft Corporation.  All rights reserved.
-->
<!--
Use of this source code is subject to the terms of the Microsoft
premium shared source license agreement under which you licensed
this source code. If you did not accept the terms of the license
agreement, you are not authorized to use this source code.
For the terms of the license, please see the license agreement
signed by you and Microsoft.
THE SOURCE CODE IS PROVIDED "AS IS", WITH NO WARRANTIES OR INDEMNITIES.
-->
<CeSecurityPolicyFile Description="Location Service macros and default policies." Vendor="Microsoft" RequiredOSVersion="7.0" FileVersion="7.0" xmlns="urn:Microsoft.PlatformBuilder/CeSecurityPolicy">

    <!-- Macros for use with Location Service -->

    <Macro Id="LS_REPORT_LATLON_EMERGENCY_GUID" Value="5BB93A3C-2874-4195-8DEA-C6A89F89F584"></Macro>

    <!-- Rules for use with Location Service -->

    
<!--Begin generating capability accounts and authorization rules for ID_CAP_LOCATION -->
<Macro Id="CAPMACRO_ID_CAP_LOCATION" Value="S-1-5-112-0-0X70-0X49445F4341505F4C4F434154494F4E" />
<Account Id="$(CAPMACRO_ID_CAP_LOCATION)" FriendlyName="ID_CAP_LOCATION:Provides access to the user Location information" Description="Autogenerated group for capability ID_CAP_LOCATION" Type="Group">
<MemberOfGroup GroupAccountId="$(PUBLIC_CAPABILITIES_GROUP_NAME)" />
</Account>
<Rule Description="Authorization rule for capability ID_CAP_LOCATION" ResourceIri="$(GLOBAL_RESOURCES)/LOCATION-SERVICE/SERVICE-CAPABILITY" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_LOCATION)" AuthorizationIds="ALL_ACCESS" />
</Authorize>
</Rule>
<Rule Description="Authorization rule for capability ID_CAP_LOCATION" ResourceIri="$(HKLM)/SYSTEM/CURRENTCONTROLSET/LOCATION%20SERVICE/CLIENT/CONFIGURATION" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_LOCATION)" AuthorizationIds="KEY_READ" />
</Authorize>
</Rule>
<Rule Description="Authorization rule for capability ID_CAP_LOCATION" ResourceIri="$(HKLM)/SYSTEM/CURRENTCONTROLSET/LOCATION%20SERVICE/SERVICE/CONFIGURATION" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_LOCATION)" AuthorizationIds="KEY_READ" />
</Authorize>
</Rule>
<Rule Description="Authorization rule for capability ID_CAP_LOCATION" ResourceIri="$(HKLM)/SYSTEM/CURRENTCONTROLSET/LOCATION%20SERVICE/PLUGINS/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_LOCATION)" AuthorizationIds="KEY_READ" />
</Authorize>
</Rule>
<Rule Description="Authorization rule for capability ID_CAP_LOCATION" ResourceIri="$(DEVICEMANAGER_DEVICE)/LOC/0" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_LOCATION)" AuthorizationIds="ALL_ACCESS" />
</Authorize>
</Rule>
<!--End generating capability accounts and authorization rules for ID_CAP_LOCATION -->


    <Rule Description="Provides the userâ€™s Location Information" ResourceIri="$(GLOBAL_RESOURCES)/LOCATION-SERVICE/SERVICE-CAPABILITY" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
        <Authorize>
            <Match AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="GENERIC_READ,GENERIC_WRITE,GENERIC_EXECUTE"></Match>
        </Authorize>
    </Rule>

    <Rule Description="Allow access to Location Service" ResourceIri="$(DEVICEMANAGER_DEVICE)/LOC/0" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
        <Authorize>
            <Match AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="ALL_ACCESS"></Match>
        </Authorize>
    </Rule>

    <Rule Description="Location Service Restricted Reports" ResourceIri="$(GLOBAL_RESOURCES)/LOCATION-SERVICE-RESTRICTED-REPORTS/$(LS_REPORT_LATLON_EMERGENCY_GUID)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
        <Authorize>
            <!--Policy engine does the check based on the joint set of permission 
            between MYPHONE_ACCOUNT_ID and SID_UDEVICE_ELEVATED (the chamber that
            Location Service is running in)-->
            <Match AccountId="$(MYPHONE_ACCOUNT_ID)" AuthorizationIds="GENERIC_READ,GENERIC_WRITE,GENERIC_EXECUTE"></Match>
            <Match AccountId="$(SID_UDEVICE_ELEVATED)" AuthorizationIds="GENERIC_READ,GENERIC_WRITE,GENERIC_EXECUTE"></Match>
        </Authorize>
        <Stop>
            <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
        </Stop>
    </Rule>

    <Rule Description="Location Service Unrestrited Reports" ResourceIri="$(GLOBAL_RESOURCES)/LOCATION-SERVICE-REPORTS/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
        <Authorize>
            <Match AccountId="$(EVERYONE_GROUP_NAME)" AuthorizationIds="GENERIC_READ,GENERIC_WRITE,GENERIC_EXECUTE"></Match>
        </Authorize>
    </Rule>

    <Rule Description="Supervisor can change service state (on/off/refresh)" ResourceIri="$(GLOBAL_RESOURCES)/LOCATION-SERVICE/SERVICE-CONFIGURE" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
        <Authorize>
            <Match AccountId="$(ELEVATED_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="GENERIC_READ,GENERIC_WRITE,GENERIC_EXECUTE"></Match>
        </Authorize>
    </Rule>

    <!-- Secure location service registry entries -->
    <Rule Description="Location Services Registry" PriorityCategoryId="PRIORITY_STANDARD" ResourceIri="$(HKLM)/System/CurrentControlSet/Location%20Service/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)">
      <Stop>
        <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
      </Stop>
    </Rule>

    <!-- Only MasterLocSwitchState is needed but individual keys are not controllable. -->
    <Rule Description="Location Services Registry Master Off/On Switch" PriorityCategoryId="PRIORITY_HIGH" ResourceIri="$(HKLM)/System/CurrentControlSet/Location%20Service/Service/Configuration/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)">
      <Authorize>
        <!-- Grant all access to standard users. -->
        <Match AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
      </Authorize>
    </Rule>

  <!-- Control access to location files. -->
    <Rule Description="Protect location directory from other chambers" PriorityCategoryId="PRIORITY_HIGH" ResourceIri="$(FILESYS_PRIMARY_ROOT)/APPLICATION%20DATA/Location/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)">
      <Authorize>
        <Match AccountId="$(ELEVATED_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="FILE_ALL_ACCESS"></Match>
      </Authorize>
      <Stop>
        <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
      </Stop>
    </Rule>
</CeSecurityPolicyFile>
