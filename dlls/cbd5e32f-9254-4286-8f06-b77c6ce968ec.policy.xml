<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (c) Microsoft Corporation.  All rights reserved.
-->
<CeSecurityPolicyFile Description="Meinfra security policy" Vendor="Microsoft" RequiredOSVersion="7.00" FileVersion="7.00" xmlns="urn:Microsoft.PlatformBuilder/CeSecurityPolicy">
  <!-- Capabilities for Yamanote applications -->
  
<!--Begin generating capability accounts and authorization rules for ID_CAP_GAMERSERVICES -->
<Macro Id="CAPMACRO_ID_CAP_GAMERSERVICES" Value="S-1-5-112-0-0X70-0X49445F4341505F47414D45525345525649434553" />
<Account Id="$(CAPMACRO_ID_CAP_GAMERSERVICES)" FriendlyName="ID_CAP_GAMERSERVICES:Allows access to Game Foundation resources for Game Apps" Description="Autogenerated group for capability ID_CAP_GAMERSERVICES" Type="Group">
<MemberOfGroup GroupAccountId="$(PUBLIC_CAPABILITIES_GROUP_NAME)" />
</Account>
<Rule Description="Authorization rule for capability ID_CAP_GAMERSERVICES" ResourceIri="$(GLOBAL_RESOURCES)/ZMF_API_COMMON/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_GAMERSERVICES)" AuthorizationIds="ALL_ACCESS" />
</Authorize>
</Rule>
<Rule Description="Authorization rule for capability ID_CAP_GAMERSERVICES" ResourceIri="$(GLOBAL_RESOURCES)/ZMF_API_XBOX_LIVE/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_GAMERSERVICES)" AuthorizationIds="ALL_ACCESS" />
</Authorize>
</Rule>
<Rule Description="Authorization rule for capability ID_CAP_GAMERSERVICES" ResourceIri="$(DEVICEMANAGER_DEVICE)/ZMF/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_GAMERSERVICES)" AuthorizationIds="ALL_ACCESS" />
</Authorize>
</Rule>
<Rule Description="Authorization rule for capability ID_CAP_GAMERSERVICES" ResourceIri="policy:/RESOURCES/$(SID_ZMF_CHAMBER)/DEVICEMANAGER/ACTIVATEDEVICE" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_GAMERSERVICES)" AuthorizationIds="ALL_ACCESS" />
</Authorize>
</Rule>
<Rule Description="Authorization rule for capability ID_CAP_GAMERSERVICES" ResourceIri="$(GLOBAL_RESOURCES)/EVENTLOG_CHANNEL/Microsoft-WindowsMobile-ZTraceChannel" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(CAPMACRO_ID_CAP_GAMERSERVICES)" AuthorizationIds="GENERIC_WRITE" />
</Authorize>
</Rule>
<!--End generating capability accounts and authorization rules for ID_CAP_GAMERSERVICES -->

  <Rule Action="CreateOrReplace" Description="Standard rights group is given all access to ZMedia service running in standard user proc group" ResourceIri="$(DEVICEMANAGER_DEVICE)/ZME/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match Action="Add" AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="ALL_ACCESS"></Match>
      <Match Action="Add" AccountId="$(ELEVATED_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>
  <Rule Description="Grant everyone read access to chipset information since Zune uses this" ResourceIri="$(HKLM)/System/Chipset/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
    <Authorize>
      <Match Action="Add" AccountId="$(EVERYONE_GROUP_NAME)" AuthorizationIds="KEY_READ"></Match>
    </Authorize>
  </Rule>
  <Rule Description="Prevent unauthorized writing to MTP and Media registry" ResourceIri="$(HKLM)/Software/Microsoft/Zune/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
    <Authorize>
      <Match Action="Add" AccountId="$(ELEVATED_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
      <Match Action="Add" AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
      <Match Action="Add" AccountId="$(EVERYONE_GROUP_NAME)" AuthorizationIds="KEY_READ"></Match>
    </Authorize>
    <Stop>
      <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
    </Stop>
  </Rule>
  <Rule Action="CreateOrReplace" Description="Standard rights group is given all access to ZMF service running in standard user proc group" ResourceIri="$(DEVICEMANAGER_DEVICE)/ZMF/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match Action="Add" AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

  <Rule Action="CreateOrReplace" Description="Standard rights group is given all access to ZMF PSL calls running in standard user proc group" ResourceIri="$(GLOBAL_RESOURCES)/ZMF_API_INTERNAL/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match Action="Add" AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

  <Rule Action="CreateOrReplace" Description="Standard rights group is given all access to ZMF common startup, shutdown, etc. APIs" ResourceIri="$(GLOBAL_RESOURCES)/ZMF_API_COMMON/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match Action="Add" AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

  <Rule Action="CreateOrReplace" Description="Standard rights group is given all access to public ZMF Game Foundation APIs" ResourceIri="$(GLOBAL_RESOURCES)/ZMF_API_XBOX_LIVE/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match Action="Add" AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

  <Rule Action="CreateOrReplace" Description="Standard rights group is given all access to public ZMF media APIs" ResourceIri="$(GLOBAL_RESOURCES)/ZMF_API_MEDIA_LIB/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match Action="Add" AccountId="$(STANDARD_RIGHTS_RESOURCE_GROUP_NAME)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>
  <Rule Description="Allow GamesUX to manage the ZMF service (GameCPL)" ResourceIri="$(DEVICEMANAGER_DEVICE)/ZMF/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
    <Authorize>
      <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>
  <Rule Description="Allow GamesUX to register a client with the PNM service (GameCPL)" ResourceIri="$(DEVICEMANAGER_DEVICE)/PNM/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
    <Authorize>
      <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

  <Rule Description="Allow SID_MEUX_STANDARD to delete RunZmfTaskLaunch link added for Update" ResourceIri="$(WINDOWS_DIRECTORY_PATH)/STARTUP/RUNZMFTASKLAUNCH.LNK" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

  <Rule Description="Allow SID_MEUX_STANDARD to delete RmObsoleteCache link added for Update" ResourceIri="$(WINDOWS_DIRECTORY_PATH)/STARTUP/RMOBSOLETECACHE.LNK" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

  <Rule Description="ZMF chamber has access to LPC (for games)" ResourceIri="policy:/RESOURCES/(CHAMBER-IN-GROUP:$(LEAST_PRIVILEGE_CHAMBER_GROUP_NAME))/KERNEL/OPENPROCESS" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
    <Authorize>
      <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

    <Rule Description="Allow ZMF Service to read data from SIM files" ResourceIri="policy:/RESOURCES/GLOBAL/SIM_FILE/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
        <Authorize>
        <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="GENERIC_READ"></Match>
        </Authorize>
    </Rule>
    <Rule Description="Allow ZMF Service to read locking status from the SIM" ResourceIri="policy:/RESOURCES/GLOBAL/SIM_PIN/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
        <Authorize>
        <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="GENERIC_READ"></Match>
        </Authorize>
    </Rule>

    <Rule Description="Allow ZMF Service access to the eventlog, part of calling DMProcessConfigXML() to ingest the Discovery provXML" ResourceIri="policy:/RESOURCES/GLOBAL/EVENTLOG_CHANNEL/System" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
        <Authorize>
        <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
        </Authorize>
    </Rule>

<!--  Needed to allow ZMF Service access to the METABASE (CM_PROXYENTRIES in particular)
    part of calling DMProcessConfigXML() to ingest the Discovery provXML -->
  <Rule ResourceIri="policy:/METABASE/./VENDOR/MSFT/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
    <Authorize>
      <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="METABASE_ALL"></Match>
    </Authorize>
  </Rule>

<!--  Needed to allow ZMF Service access to the the following Registry entries for DMProcessConfigXML() -->
  <Rule ResourceIri="policy:/REGISTRY/HKLM/COMM/CMPOLICYTABLE/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
    <Authorize>
      <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>

  <Rule ResourceIri="policy:/REGISTRY/HKLM/SECURITY/WAP/PGLIST/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
    <Authorize>
      <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
    </Authorize>
  </Rule>



  <Macro Id="MULTIMEDIA_SUPERVISOR_SELF_ISOLATED" Description="Supervisor Self Isolated Chamber to run Multimedia processes" Value="S-1-5-112-0-0X11-0X00000003"></Macro>

    <!--  Needed to allow ZMF Service access to the RIL devices to extract IMEI, MEID, NAI fields -->
    <Rule ResourceIri="policy:/DEVICEMANAGER/DEVICE/RIL/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
        <Authorize>
            <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
        </Authorize>
    </Rule>
    <Rule ResourceIri="policy:/RESOURCES/GLOBAL/RIL/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
        <Authorize>
            <Match AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
        </Authorize>
    </Rule>
    <Rule Description="Prevent unauthorized access of ZME related events" ResourceIri="policy:/KERNEL/EVENT/SYSTEM/ZME/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">

      <Authorize>
        <Match Action="Add" AccountId="$(MULTIMEDIA_SUPERVISOR_SELF_ISOLATED)" AuthorizationIds="ALL_ACCESS"></Match>
        <Match Action="Add" AccountId="$(SID_MEUX_STANDARD)" AuthorizationIds="ALL_ACCESS"></Match>
      </Authorize>
      <Stop>
          <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
      </Stop>

</Rule>

</CeSecurityPolicyFile>
