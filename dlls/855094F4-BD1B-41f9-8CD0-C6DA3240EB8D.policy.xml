<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (c) Microsoft Corporation.  All rights reserved.
-->
<CeSecurityPolicyFile Description="SapiSvr.exe policy definition" Vendor="Microsoft" RequiredOSVersion="7.00" FileVersion="7.00" xmlns="urn:Microsoft.PlatformBuilder/CeSecurityPolicy">
    <!-- Run SapiSvr.exe in its own self isolated standard chamber -->
    
<!--Begin Generated accounts and routing/authz rules for S-1-5-112-0-0X21-0X00000002 -->
<Macro Id="SID_SAPISVR" Value="S-1-5-112-0-0X21-0X00000002" />
<Account Id="$(SID_SAPISVR)" FriendlyName="SapiSvr.exe" Description="Autogenerated chamber for SapiSvr.exe" Type="User">
<MemberOfGroup GroupAccountId="$(SELF_ISOLATED_STANDARD_RIGHTS_CHAMBER_GROUP_NAME)" />
</Account>
<!--Begin Generated routing/authz rules for SapiSvr.exe -->
<Rule Description="Route SapiSvr.exe" ResourceIri="$(LOADERVERIFIER_ROUTE_BY_NAME)/PRIMARY/WINDOWS/SAPISVR.EXE" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_LOW">
<Authorize>
<Match AccountId="$(SID_SAPISVR)" AuthorizationIds="LV_ACCESS_EXECUTE" />
</Authorize>
</Rule>
<Rule Description="Authorize SapiSvr.exe be loadable to $(SID_SAPISVR) and  chambers" ResourceIri="$(LOADERVERIFIER_EXE_AUTHZ_INROM_ROOT)/WINDOWS/SAPISVR.EXE" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(SID_SAPISVR)" AuthorizationIds="LV_ACCESS_EXECUTE,LV_ACCESS_LOAD" />
</Authorize>
</Rule>
<!--End Generated routing/authz rules for SapiSvr.exe -->
<!--End Generated accounts and routing/authz rules for S-1-5-112-0-0X21-0X00000002 -->


    <!-- 
    SpeechCPL needs a chamber separate from SapiSvr: settings3.exe (in -0X10-) needs to be able to send window messages
    to it, which cannot be done to chambers in -0X21-; only TCB has access to that capability.  Rather than adding a
    grant for settings3.exe to send window messages to both SpeechCPL and SapiSvr, it's probably better to completely
    separate SpeechCPL and SapiSvr's capabilities.
    -->
    
<!--Begin Generated accounts and routing/authz rules for S-1-5-112-0-0X20-0X0000002B -->
<Macro Id="SID_SPEECHCPL" Value="S-1-5-112-0-0X20-0X0000002B" />
<Account Id="$(SID_SPEECHCPL)" FriendlyName="SpeechCPL.exe" Description="Autogenerated chamber for SpeechCPL.exe" Type="User">
<MemberOfGroup GroupAccountId="$(STANDARD_RIGHTS_CHAMBER_GROUP_NAME)" />
</Account>
<!--Begin Generated routing/authz rules for SpeechCPL.exe -->
<Rule Description="Route SpeechCPL.exe" ResourceIri="$(LOADERVERIFIER_ROUTE_BY_NAME)/PRIMARY/WINDOWS/SPEECHCPL.EXE" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_LOW">
<Authorize>
<Match AccountId="$(SID_SPEECHCPL)" AuthorizationIds="LV_ACCESS_EXECUTE" />
</Authorize>
</Rule>
<Rule Description="Authorize SpeechCPL.exe be loadable to $(SID_SPEECHCPL) and  chambers" ResourceIri="$(LOADERVERIFIER_EXE_AUTHZ_INROM_ROOT)/WINDOWS/SPEECHCPL.EXE" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
<Authorize>
<Match AccountId="$(SID_SPEECHCPL)" AuthorizationIds="LV_ACCESS_EXECUTE,LV_ACCESS_LOAD" />
</Authorize>
</Rule>
<!--End Generated routing/authz rules for SpeechCPL.exe -->
<!--End Generated accounts and routing/authz rules for S-1-5-112-0-0X20-0X0000002B -->

    
    <!-- This is actually just the elevated rights chamber used for several services (inc BTAGSvc) -->
    <Macro Id="SID_TELLMEWINDOWSERVICE" Description="Tws.dll user SID" Value="S-1-5-112-0-0X10-0X00000001"></Macro>

    <Macro Id="SID_SHORTMSGPLUGIN" Description="Short Message Plugin Service" Value="S-1-5-112-0-0X10-0X00000006"></Macro>

    <Macro Id="SID_ACCESSIBILITY_CPL" Description="Accessibility CPL" Value="S-1-5-112-0-0X10-0X00000031"></Macro>

  <!-- grammar file authz -->
    <Rule Description="Allow TWS to create the AppData/Microsoft/Speech directory" ResourceIri="$(FILESYS_PRIMARY_ROOT)/APPLICATION%20DATA/MICROSOFT" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match AccountId="$(SID_TELLMEWINDOWSERVICE)" AuthorizationIds="FILE_GENERIC_WRITE"></Match>
      </Authorize>
    </Rule>
    
    <Rule Description="Allow TWS to create the AppData/Microsoft/Speech/Grammars directory" ResourceIri="$(FILESYS_PRIMARY_ROOT)/APPLICATION%20DATA/MICROSOFT/SPEECH" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match AccountId="$(SID_TELLMEWINDOWSERVICE)" AuthorizationIds="FILE_ALL_ACCESS"></Match>
        <Match AccountId="$(SID_SAPISVR)" AuthorizationIds="FILE_GENERIC_READ"></Match>
      </Authorize>
      <Stop>
        <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
      </Stop>
    </Rule>
    
    <Rule Description="Allow TWS R/W access and SapiSvr R/O access to the SpeechUX grammars" ResourceIri="$(FILESYS_PRIMARY_ROOT)/APPLICATION%20DATA/MICROSOFT/SPEECH/GRAMMARS/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match AccountId="$(SID_TELLMEWINDOWSERVICE)" AuthorizationIds="FILE_ALL_ACCESS"></Match>
        <Match AccountId="$(SID_SAPISVR)" AuthorizationIds="FILE_GENERIC_READ"></Match>
      </Authorize>
      <Stop>
        <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
      </Stop>
    </Rule>
    
    <!-- registry authz -->

    <!-- everyone has read access to hkcu/software; no rule necessary for hkcu/software/microsoft/speech/tws -->
    
    <Rule Description="Allow SapiSvr and SpeechCPL R/W access, and TWS R/O access, to the speech settings" ResourceIri="$(HKCU)/SOFTWARE/MICROSOFT/SPEECH/SETTINGS" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
      <Authorize>
        <Match AccountId="$(SID_SAPISVR)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
        <Match AccountId="$(SID_SPEECHCPL)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
        <Match AccountId="$(SID_TELLMEWINDOWSERVICE)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
        <Match AccountId="$(SID_ACCESSIBILITY_CPL)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
        <Match AccountId="$(WEBSEARCH_EXE_SID)" AuthorizationIds="KEY_READ"></Match>
        <!-- Settings3 needs to be able to read the audio notifications setting for the secondary line in the cpl list. -->
        <Match AccountId="$(SETTINGS3_EXE_SID)" AuthorizationIds="KEY_READ"></Match>
        <!-- ShortMsgPlugin needs to be able to read the audio notifications setting for incoming SMS announcement. -->
        <Match AccountId="$(SID_SHORTMSGPLUGIN)" AuthorizationIds="KEY_READ"></Match>
      </Authorize>
      <Stop>
        <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
      </Stop>
    </Rule>
    
    <Rule Description="Allow SapiSvr all access to UX related settings (backup grammar file names, etc...)" ResourceIri="$(HKCU)/SOFTWARE/MICROSOFT/SPEECH/UX" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
      <Authorize>
        <Match AccountId="$(SID_SAPISVR)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
      </Authorize>
      <Stop>
        <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
      </Stop>
    </Rule>
    
    <Rule Description="Allow SapiSvr to read the TestHook registry settings" ResourceIri="$(HKCU)/SOFTWARE/MICROSOFT/SPEECH/UX/TESTHOOK/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_HIGH">
      <Authorize>
        <Match AccountId="$(SID_SAPISVR)" AuthorizationIds="KEY_ALL_ACCESS"></Match>
        <Match AccountId="$(SID_TELLMEWINDOWSERVICE)" AuthorizationIds="KEY_READ"></Match>
      </Authorize>
      <Stop>
        <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
      </Stop>
    </Rule>

    <!-- Device Manager team will remove this rule with fix for WM7 94531 -->
    <Rule Description="Base device 'bus name' policy rule" ResourceIri="$(DEVICEMANAGER_BUS)/SERVICES" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match Action="Add" AccountId="$(SID_SAPISVR)" AuthorizationIds="ALL_ACCESS"></Match>
      </Authorize>
    </Rule>

    <Rule Description="Allow sapisvr to access proximity sensor" ResourceIri="$(DEVICEMANAGER_DEVICE)/PRX/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match Action="Add" AccountId="$(SID_SAPISVR)" AuthorizationIds="ALL_ACCESS"></Match>
      </Authorize>
    </Rule>

    <Rule Description="Allow sapisvr to access TWS" ResourceIri="$(DEVICEMANAGER_DEVICE)/TWS/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match Action="Add" AccountId="$(SID_SAPISVR)" AuthorizationIds="ALL_ACCESS"></Match>
      </Authorize>
    </Rule>
      
    <Rule Description="Allow sapisvr to access BAG" ResourceIri="$(DEVICEMANAGER_DEVICE)/BAG/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match Action="Add" AccountId="$(SID_SAPISVR)" AuthorizationIds="ALL_ACCESS"></Match>
      </Authorize>
    </Rule>
      
    <Rule Description="Allow sapisvr.exe to call the SpeechUX APIs hosted in telshell.exe" ResourceIri="$(GLOBAL_RESOURCES)/SPEECH/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match Action="Add" AccountId="$(SID_SAPISVR)" AuthorizationIds="GENERIC_ALL"></Match>
      </Authorize>
    </Rule>

    <Rule Description="Allow WebSearch and BTAGSvc to invoke speech - via telshell.exe" ResourceIri="$(GLOBAL_RESOURCES)/SPEECH/SpeechUXInvoke" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
        <Match Action="Add" AccountId="$(WEBSEARCH_EXE_SID)" AuthorizationIds="GENERIC_ALL"></Match>
        <Match Action="Add" AccountId="$(SID_TELLMEWINDOWSERVICE)" AuthorizationIds="GENERIC_ALL"></Match>
      </Authorize>
    </Rule>

    <Rule Description="Allow ShortMsgPlugin to invoke speech, done thru servicesd.exe" ResourceIri="$(GLOBAL_RESOURCES)/SPEECH/SpeechUXContextualMessageInvoke" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
      <Authorize>
         <Match Action="Add" AccountId="$(SID_SHORTMSGPLUGIN)" AuthorizationIds="GENERIC_ALL"></Match>
        <Match Action="Add" AccountId="$(SID_SPEECHCPL)" AuthorizationIds="GENERIC_ALL"></Match>
      </Authorize>
    </Rule>

    <Rule Description="Allow sapisvr.exe to access RPC client interface for Messenger Service" ResourceIri="$(RPC_CLIENT_INTERFACE)/b9fc272f-5185-4afa-a506-24a089ab1a02/(*)" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
    <Authorize>
      <Match Action="Add" AccountId="$(SID_SAPISVR)" AuthorizationIds="GENERIC_ALL"></Match>
    </Authorize>
    <Stop>
      <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
    </Stop>
  </Rule>

    <!-- Protect Sync message queue from everyone -->
    <!-- queue defined in: private/speech/dev/ux/WinMo/common/inc/uxconstants.h -->
    <!-- SapiSvr could read/write into queue, but SpeechCPL.exe could only read -->
    <Rule Action="CreateOrReplace" Description="Used for sending dictation result from sapisvr to SpeechCPL" ResourceIri="policy:/KERNEL/MSGQUEUE/GLOBAL/Speech_Dictation:R" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
        <Authorize>
            <Match Action="Add" AccountId="$(SID_SAPISVR)" AuthorizationIds="ALL_ACCESS"></Match>
            <Match Action="Add" AccountId="$(SID_SPEECHCPL)" AuthorizationIds="ALL_ACCESS"></Match>
        </Authorize>
        <Stop>
            <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
        </Stop>
    </Rule>
    <!-- SapiSvr could read/write into queue, but SpeechCPL.exe could only read -->
    <Rule Action="CreateOrReplace" Description="Used for sending dictation result from sapisvr to SpeechCPL" ResourceIri="policy:/KERNEL/MSGQUEUE/GLOBAL/Speech_Dictation:W" SpeakerAccountId="$(SYSTEM_USER_NAME)" PriorityCategoryId="PRIORITY_STANDARD">
        <Authorize>
            <Match Action="Add" AccountId="$(SID_SAPISVR)" AuthorizationIds="ALL_ACCESS"></Match>
        </Authorize>
        <Stop>
            <Match AccountId="$(EVERYONE_GROUP_NAME)"></Match>
        </Stop>
    </Rule>
</CeSecurityPolicyFile>
